<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel: Shoptet Alena</title>
    <style>
        :root {
            --primary: #0066cc;
            --success: #28a745;
            --danger: #dc3545;
            --bg: #f4f6f9;
            --card: #ffffff;
            --text: #333333;
            --border: #e0e0e0;
        }

        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        h1 { font-size: 1.5rem; margin-bottom: 10px; color: #2c3e50; }
        h2 { font-size: 1.2rem; margin: 0 0 15px 0; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        hr { border: 0; border-top: 1px solid #ccc; margin: 20px 0; }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Button Styles */
        .btn { border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background 0.2s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; max-width: 300px; display: block; margin-bottom: 20px; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        
        /* Grid Layout */
        .orders-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .orders-grid { grid-template-columns: 1fr 1fr; } }

        /* Order Card */
        .order-card { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        
        /* Step Item */
        .step-item { display: flex; align-items: flex-start; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .step-item:last-child { border-bottom: none; }
        
        .checkbox-wrapper { margin-right: 15px; position: relative; top: 2px; }
        .custom-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: var(--success); }
        
        .step-content { flex: 1; }
        .step-text { font-size: 0.95rem; margin-bottom: 4px; display: block; }
        .step-time { font-size: 0.75rem; color: #888; display: block; }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: slideDown 0.3s ease; }
        .modal-title { font-size: 1.2rem; margin-bottom: 15px; font-weight: bold; }
        .modal-input { width: 100%; padding: 10px; margin: 10px 0 20px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-warning { color: var(--danger); font-size: 0.9rem; margin-bottom: 15px; background: #fff3cd; padding: 10px; border-left: 4px solid var(--danger); }
        
        /* Sub-option indentation */
        .indent { margin-left: 25px; border-left: 2px solid #eee; padding-left: 10px; }

        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>Admin panel: Shoptet aktivní objednávky Alena</h1>
        <hr>
        <button class="btn btn-primary" onclick="openCreateModal()">Založit novou objednávku</button>
        
        <div id="orders-container" class="orders-grid">
            </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-box">
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, remove, set } 
        from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDAUEi98gTeiWeNZHf6W73UpZGluS3N8bI",
            authDomain: "shoptet-alena-packety.firebaseapp.com",
            databaseURL: "https://shoptet-alena-packety-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "shoptet-alena-packety",
            storageBucket: "shoptet-alena-packety.firebasestorage.app",
            messagingSenderId: "717548214526",
            appId: "1:717548214526:web:8a8de5587c2aa4f50bedaf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Definice kroků (Blueprint) ---
        const initialSteps = [
            { id: 1, text: "Vyhráli jste! Objednávka přijata...", type: "standard", done: false, time: null },
            { id: 2, text: "Kontrolujeme Vaši objednávku", type: "standard", done: false, time: null },
            { id: 3, text: "Způsob platby: ?,?", type: "payment_choice", done: false, time: null },
            { id: 4, text: "Objednávku jsme přijali ke zpracování", type: "standard", done: false, time: null },
            { id: 5, text: "Objednávku jsme předali ke zpracování", type: "standard", done: false, time: null },
            { id: 6, text: "Objednávku jsme zabalili", type: "standard", done: false, time: null },
            { id: 7, text: "Objednávka byla předána a bude převezena na: ?", type: "delivery_loc", done: false, time: null },
            { id: 8, text: "Způsob dopravy: Tracking zásilky / přeprava k osobnímu předání?", type: "courier_choice", done: false, time: null },
            { id: 9, text: "Převážíme zásilku.", type: "standard", done: false, time: null },
            { id: 10, text: "Zásilka k vyzvednutí, heslo: ?", type: "password_set", done: false, time: null },
            { id: 11, text: "Zásilka vyzvednuta", type: "standard", done: false, time: null },
            { id: 12, text: "Přeprava dokončena", type: "final_delete", done: false, time: null }
        ];

        // --- Globální funkce pro UI ---
        window.openCreateModal = () => {
            const modal = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <div class="modal-title">Založit novou objednávku</div>
                <label>Zadat název aukce / výhry jako název objednávky:</label>
                <input type="text" id="new-order-name" class="modal-input" placeholder="Např. Notebook Funkční Acer 19W5">
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal()">Zrušit</button>
                    <button class="btn btn-success" onclick="createOrder()">Potvrdit</button>
                </div>
            `;
            modal.style.display = 'flex';
        };

        window.closeModal = () => {
            document.getElementById('modal-overlay').style.display = 'none';
        };

        window.createOrder = () => {
            const name = document.getElementById('new-order-name').value;
            if(!name) return alert("Zadejte název!");
            
            const ordersRef = ref(db, 'orders');
            push(ordersRef, {
                name: name,
                createdAt: Date.now(),
                steps: initialSteps
            });
            closeModal();
        };

        // --- Logika vykreslování ---
        const ordersContainer = document.getElementById('orders-container');

        onValue(ref(db, 'orders'), (snapshot) => {
            ordersContainer.innerHTML = '';
            const data = snapshot.val();
            
            if (data) {
                // Převést na pole a seřadit (nejnovější nahoře, volitelně)
                const orders = Object.entries(data).reverse(); 

                orders.forEach(([key, order]) => {
                    const card = document.createElement('div');
                    card.className = 'order-card';
                    
                    let stepsHtml = '';
                    if(order.steps) {
                        order.steps.forEach((step, index) => {
                            const isChecked = step.done ? 'checked' : '';
                            const timeStr = step.time ? new Date(step.time).toLocaleString('cs-CZ', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'}) : '';
                            const indentClass = step.indent ? 'indent' : '';

                            stepsHtml += `
                                <div class="step-item ${indentClass}">
                                    <div class="checkbox-wrapper">
                                        <input type="checkbox" class="custom-checkbox" 
                                            ${isChecked} 
                                            onchange="handleStepChange('${key}', ${index}, this.checked, '${step.type}')">
                                    </div>
                                    <div class="step-content">
                                        <span class="step-text">${step.text}</span>
                                        ${timeStr ? `<span class="step-time">${timeStr}</span>` : ''}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    card.innerHTML = `
                        <h2>${order.name}</h2>
                        <div class="steps-list">${stepsHtml}</div>
                    `;
                    ordersContainer.appendChild(card);
                });
            }
        });

        // --- Hlavní logika změn (Handle Change) ---
        window.handleStepChange = (orderId, stepIndex, isChecked, type) => {
            const orderRef = ref(db, `orders/${orderId}/steps`);
            
            // Získání aktuálního stavu objednávky pro manipulaci
            onValue(ref(db, `orders/${orderId}`), (snapshot) => {
                const orderData = snapshot.val();
                let steps = orderData.steps;
                const currentStep = steps[stepIndex];

                // Pokud odškrtáváme (z 1 na 0), jen uložíme
                if (!isChecked) {
                    steps[stepIndex].done = false;
                    steps[stepIndex].time = null;
                    update(ref(db, `orders/${orderId}`), { steps: steps });
                    return; // Konec, neřešíme modaly
                }

                // Pokud zaškrtáváme (z 0 na 1) -> Řešíme logiku
                const now = Date.now();

                // 1. Způsob platby
                if (type === 'payment_choice') {
                    // Reset checkboxu vizuálně, dokud nevybere
                    renderPaymentModal(orderId, stepIndex, steps);
                    return; 
                }

                // 2. Čekáme na přijetí platby (IBAN sub-step)
                if (type === 'payment_waiting') {
                     renderAmountModal(orderId, stepIndex, steps, "Zadat cenu k platbě:", "Čekáme na přijetí platby:");
                     return;
                }

                // 3. Doručení (Výdejní místo / Adresa)
                if (type === 'delivery_loc') {
                    renderDeliveryLocModal(orderId, stepIndex, steps);
                    return;
                }

                // 4. Předání dopravci (Kurýr / Osobní)
                if (type === 'courier_choice') {
                    renderCourierModal(orderId, stepIndex, steps);
                    return;
                }

                // 5. Heslo
                if (type === 'password_set') {
                    renderPasswordModal(orderId, stepIndex, steps);
                    return;
                }

                // 6. Konec (Smazat)
                if (type === 'final_delete') {
                    renderDeleteWarning(orderId);
                    // Checkbox vracíme na false, dokud nepotvrdí smazání
                    document.querySelector(`input[onchange*="${stepIndex}"]`).checked = false; 
                    return;
                }

                // Defaultní chování (jen update času a stavu)
                steps[stepIndex].done = true;
                steps[stepIndex].time = now;
                update(ref(db, `orders/${orderId}`), { steps: steps });

            }, { onlyOnce: true });
        };

        // --- Specifické Modaly a Logika ---

        // 1. Platba
        function renderPaymentModal(orderId, index, steps) {
            const modal = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <div class="modal-title">Zvolit způsob platby:</div>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <button class="btn btn-primary" onclick="processPayment('${orderId}', ${index}, 'dobirka')">Při doručení balíku na dobírku</button>
                    <button class="btn btn-primary" onclick="processPayment('${orderId}', ${index}, 'iban')">Převodem na účet IBAN-NTS</button>
                </div>
            `;
            modal.style.display = 'flex';
            // Vracíme checkbox na false, kdyby to zavřel
            document.querySelector(`input[onchange*="${index}"]`).checked = false;
        }

        window.processPayment = (orderId, index, method) => {
            if (method === 'dobirka') {
                renderAmountModal(orderId, index, null, "Zadat cenu dobírky:", "Dobírka (zaplatíte při převzetí blíku):", true);
            } else {
                // IBAN -> Přidat pod-možnosti
                // Musíme načíst steps znovu, upravit pole a uložit
                onValue(ref(db, `orders/${orderId}/steps`), (snap) => {
                    let steps = snap.val();
                    steps[index].text = "Způsob platby: Převodem na účet IBAN-NTS";
                    steps[index].done = true;
                    steps[index].time = Date.now();
                    steps[index].type = "standard"; // Už to není choice

                    // Vložit nové kroky
                    const newSteps = [
                        { text: "Čekáme na přijetí platby: ? Kč", type: "payment_waiting", done: false, time: null, indent: true },
                        { text: "Zaplaceno", type: "standard", done: false, time: null, indent: true }
                    ];
                    steps.splice(index + 1, 0, ...newSteps);
                    
                    update(ref(db, `orders/${orderId}`), { steps: steps });
                    closeModal();
                }, { onlyOnce: true });
            }
        };

        // Univerzální modal pro cenu (Dobírka i Platba)
        function renderAmountModal(orderId, index, steps, title, prefix, isDobirkaUpdate = false) {
            const modal = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <div class="modal-title">${title}</div>
                <input type="text" id="amount-input" class="modal-input" placeholder="Pouze čísla">
                <div id="amount-error" style="color:red; display:none; margin-bottom:10px;">Zadávejte pouze čísla!</div>
                <div class="modal-actions">
                    <button class="btn btn-success" onclick="confirmAmount('${orderId}', ${index}, '${prefix}', ${isDobirkaUpdate})">Potvrdit</button>
                </div>
            `;
            modal.style.display = 'flex';
        }

        window.confirmAmount = (orderId, index, prefix, isDobirkaUpdate) => {
            const val = document.getElementById('amount-input').value;
            if (!/^\d+$/.test(val)) {
                document.getElementById('amount-error').style.display = 'block';
                return;
            }

            onValue(ref(db, `orders/${orderId}/steps`), (snap) => {
                let steps = snap.val();
                steps[index].text = `${prefix} ${val} Kč`;
                steps[index].done = true;
                steps[index].time = Date.now();
                if(isDobirkaUpdate) steps[index].type = "standard"; // Fix type
                
                update(ref(db, `orders/${orderId}`), { steps: steps });
                closeModal();
            }, { onlyOnce: true });
        };

        // 3. Doručení (Výdejní místo / Adresa)
        function renderDeliveryLocModal(orderId, index, steps) {
             const modal = document.getElementById('modal-overlay');
             const content = document.getElementById('modal-content');
             content.innerHTML = `
                <div class="modal-title">Poloha doručení</div>
                <div style="margin-bottom:10px;">
                    <label><input type="radio" name="del_type" value="Výdejní místo" checked> Výdejní místo</label>
                    <label style="margin-left:15px;"><input type="radio" name="del_type" value="Adresa"> Adresa</label>
                </div>
                <label>Poloha:</label>
                <input type="text" id="loc-text" class="modal-input">
                <div class="modal-actions">
                     <button class="btn btn-success" onclick="confirmLoc('${orderId}', ${index})">Uložit</button>
                </div>
             `;
             modal.style.display = 'flex';
             document.querySelector(`input[onchange*="${index}"]`).checked = false;
        }

        window.confirmLoc = (orderId, index) => {
            const type = document.querySelector('input[name="del_type"]:checked').value;
            const text = document.getElementById('loc-text').value;
            
            onValue(ref(db, `orders/${orderId}/steps`), (snap) => {
                let steps = snap.val();
                steps[index].text = `Objednávka byla předána dopravci a bude převezena na: ${type} - ${text}`;
                steps[index].done = true;
                steps[index].time = Date.now();
                update(ref(db, `orders/${orderId}`), { steps: steps });
                closeModal();
            }, { onlyOnce: true });
        };

        // 4. Dopravce (Kurýr / Osobní)
        function renderCourierModal(orderId, index, steps) {
            const modal = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <div class="modal-title">Zadat způsob přepravy</div>
                <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:15px;">
                     <button class="btn btn-secondary" onclick="confirmCourier('${orderId}', ${index}, 'osobni')">Osobní předání</button>
                     <button class="btn btn-primary" onclick="showTrackingInput('${orderId}', ${index})">Doprava kurýrem</button>
                </div>
            `;
            modal.style.display = 'flex';
            document.querySelector(`input[onchange*="${index}"]`).checked = false;
        }

        window.confirmCourier = (orderId, index, type) => {
            onValue(ref(db, `orders/${orderId}/steps`), (snap) => {
                let steps = snap.val();
                if (type === 'osobni') {
                    steps[index].text = "Objednávka odeslána a po převozu ji připravíme k osobnímu předání...";
                } 
                steps[index].done = true;
                steps[index].time = Date.now();
                update(ref(db, `orders/${orderId}`), { steps: steps });
                closeModal();
            }, { onlyOnce: true });
        };

        window.showTrackingInput = (orderId, index) => {
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <div class="modal-title">Sledování zásilky</div>
                <label>Zadat odkaz pro sledování:</label>
                <input type="text" id="track-link" class="modal-input">
                <div class="modal-actions">
                     <button class="btn btn-success" onclick="saveTracking('${orderId}', ${index})">Uložit</button>
                </div>
            `;
        };

        window.saveTracking = (orderId, index) => {
            const link = document.getElementById('track-link').value;
            onValue(ref(db, `orders/${orderId}/steps`), (snap) => {
                let steps = snap.val();
                // Speciální formátování pro tracking link - uložíme HTML do textu
                // Poznámka: V Adminu to bude vypadat jako HTML kód nebo text, ale pro funkčnost je to OK.
                // Pro čistotu zde uložíme speciální flag, ale zadání říká "nahradit X tlačítkem".
                // Uložíme text jako JSON string nebo marker, který pak user view rozparsuje.
                // Zde jednoduše uložíme: "TRACKING_BTN|URL"
                steps[index].text = `TRACKING_BTN|${link}`;
                steps[index].done = true;
                steps[index].time = Date.now();
                update(ref(db, `orders/${orderId}`), { steps: steps });
                closeModal();
            }, { onlyOnce: true });
        };

        // 5. Heslo
        function renderPasswordModal(orderId, index, steps) {
            const modal = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <div class="modal-title">Zadat heslo</div>
                <input type="text" id="pwd-input" class="modal-input">
                <div class="modal-actions">
                     <button class="btn btn-success" onclick="savePassword('${orderId}', ${index})">Uložit</button>
                </div>
            `;
            modal.style.display = 'flex';
            document.querySelector(`input[onchange*="${index}"]`).checked = false;
        }

        window.savePassword = (orderId, index) => {
            const val = document.getElementById('pwd-input').value;
            onValue(ref(db, `orders/${orderId}/steps`), (snap) => {
                let steps = snap.val();
                steps[index].text = `Zásilka k vyzvednutí, heslo: ${val}`;
                steps[index].done = true;
                steps[index].time = Date.now();
                update(ref(db, `orders/${orderId}`), { steps: steps });
                closeModal();
            }, { onlyOnce: true });
        };

        // 6. Smazat
        function renderDeleteWarning(orderId) {
            const modal = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <div class="modal-title" style="color:var(--danger)">⚠️ Pozor!</div>
                <div class="modal-warning">
                    Varování: Pokračováním bude ukončena přeprava této zásilky a dojde k jejímu nevratnému smazání! Tohle udělat pouze, pokud je zásilka doručena!
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal()">Zpět</button>
                    <button class="btn btn-danger" onclick="deleteOrder('${orderId}')">Pokračovat a smazat</button>
                </div>
            `;
            modal.style.display = 'flex';
        }

        window.deleteOrder = (orderId) => {
            remove(ref(db, `orders/${orderId}`));
            closeModal();
        };

    </script>
</body>

</html>


